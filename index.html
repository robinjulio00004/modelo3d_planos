<!doctype html>
<!--clipping planes GLTF model-->
<html lang="en-US">
	<head>
	<meta charset="utf-8"/> 
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<script src="aframe-v1.5.0.min.js"></script>
    <script src="aframe-ar.js"></script>
	<script src="orbit-controls.js"></script>
	<script src="animation-mixer.js"></script>
	<!--<script src="mi_script.js"></script>-->
	<link rel="stylesheet" href="styles.css">	
	</head>
	<script>
		AFRAME.registerComponent('clipping-plane', {
      schema: {
        dir: { type: 'vec3', default: { x: 0, y: 0, z: 0 } },
        position: { type: 'vec3', default: { x: 0, y: 0, z: 0 } },
        useEntityPos: { type: 'boolean', default: true },
        enabled: { type: 'boolean', default: true },
      },

      init: function () {
        const renderer = this.el.sceneEl.renderer;
        const entityPosition = this.el.getAttribute('position') || { x: 0, y: 0, z: 0 };
        const position = this.data.useEntityPos ? entityPosition : this.data.position;
        const planePosition = new THREE.Vector3(position.x, position.y,position.z );
        const dir = new THREE.Vector3(this.data.dir.x,this.data.dir.y,this.data.dir.z);
        
        dir.normalize();
        this.clippingPlane = new THREE.Plane();
        this.clippingPlane.setFromNormalAndCoplanarPoint(dir, planePosition);

        if (this.el.getAttribute("gltf-model")) {
          this.el.addEventListener('model-loaded', (e) => {
          this.modelLoaded = true;
          const object = e.detail.model;
          object.traverse((node) => {
            if (!node.isMesh) return;
            node.material.clipShadows = true;
            node.material.clippingPlanes = this.data.enabled ? [this.clippingPlane] : [];
            node.material.side = THREE.DoubleSide;
            node.castShadow = true;
            node.material.needsUpdate = true;
          });
        });
        } else {
          this.el.object3D.traverse((node) => {
          if (!node.isMesh) return;
          node.material.clippingPlanes = this.data.enabled ? [this.clippingPlane] : [];
          node.material.clipShadows = true;
          node.material.side = THREE.DoubleSide;
          node.castShadow = true;
          node.material.needsUpdate = true;
        });
        }
        renderer.localClippingEnabled = true;        
      },

update: function (oldData) {
        if (oldData.dir !== this.data.dir || oldData.position !== this.data.position || oldData.useEntityPos !== this.data.useEntityPos) {
          const entityPosition = this.el.getAttribute('position') || { x: 0, y: 0, z: 0 };
          const position = this.data.useEntityPos ? entityPosition : this.data.position;
          const planePosition = new THREE.Vector3(position.x, position.y, position.z);
          const dir = new THREE.Vector3(this.data.dir.x,this.data.dir.y,this.data.dir.z);

          this.clippingPlane.setFromNormalAndCoplanarPoint(dir, planePosition);
        }

        if (this.el.getAttribute("gltf-model")) {
          this.el.object3D.traverse((node) => {
          if (!node.isMesh) return;
          node.material.clippingPlanes = this.data.enabled ? [this.clippingPlane] : [];
          node.material.needsUpdate = true;
          node.material.clipShadows = true;
        });
        } else {
          this.el.object3D.traverse((node) => {
          if (!node.isMesh) return;
          node.material.clippingPlanes = this.data.enabled ? [this.clippingPlane] : [];
          node.material.needsUpdate = true;
          node.material.clipShadows = true;
        });
        }
      },
    });

AFRAME.registerComponent('mi_ccplane',{
        schema: {
        dir: { type: 'vec3', default: { x: 0, y: 0, z: 0 } }
    },
  init:function(){
    const direc = new THREE.Vector3(this.data.dir.x,this.data.dir.y,this.data.dir.z);
    var clippingPlane,planeHelper;

    clippingPlane = new THREE.Plane(new THREE.Vector3(direc.x,direc.y,direc.z)); 
    planeHelper = new THREE.PlaneHelper(clippingPlane, 3, 0xff00ff); 
    this.el.object3D.add(planeHelper);
  }
});

AFRAME.registerComponent('mi_ccplane2',{
        schema: {
        dir: { type: 'vec3', default: { x: 0, y: 0, z: 0 } }
    },
  init:function(){
    const direc = new THREE.Vector3(this.data.dir.x,this.data.dir.y,this.data.dir.z);
    var clippingPlane,planeHelper;

    clippingPlane = new THREE.Plane(new THREE.Vector3(direc.x,direc.y,direc.z),0); 
    planeHelper = new THREE.PlaneHelper(clippingPlane, 3, 0xff00ff); 
    this.el.object3D.add(planeHelper);
  }
});
	</script>
		
<body>
<div id="lista">
    <label for="menu" id="menu">Vistas de secci√≥n  &nbsp;</label>
    <select name="vistas" id="svistas">
      <option id="boton1" value="svista">sin vista</option>
      <option id="boton2" value="cvista">con vista</option>
      <option id="boton3" value="vistax">vista en x</option>
      <option id="boton4" value="vistay">vista en y</option>
      <option id="boton5" value="vistaz">vista en z</option>
    </select>
    <label for="button6">&nbsp;&nbsp;Plano</label>
        <input id="button6" type="checkbox">
   </div>

    <a-scene arjs embedded renderer="logarithmicDepthBuffer: true;antialias: true;" xr-mode-ui="enabled: true">
      
      <a-assets>
      <a-asset-item id="motor" src="motor_brush.glb"></a-asset-item>
      </a-assets>
        
<a-entity id="modelo3d" position="0 -0.75 0" scale="0.5 0.5 0.5" gltf-model="#motor" animation-mixer clipping-plane></a-entity>
    <a-entity id="plano1" visible="false" mi_ccplane="dir:0 0 1"></a-entity>
    <a-entity id="plano2" visible="false" mi_ccplane="dir:1 0 0"></a-entity>
    <a-entity id="plano3" visible="false" mi_ccplane2="dir:0 1 0"></a-entity>
      
<a-entity camera look-controls="enabled: false" orbit-controls="target: 0 0 0; minDistance: 10; maxDistance: 10; initialPosition: 1 2 3; rotateSpeed: 1;autoRotate:true">
   </a-entity>
  </a-scene>
</body>
	<script>
		const myCheckbox = document.getElementById('button6');
		const entidad = document.querySelector('#modelo3d');

document.getElementById('boton1').addEventListener('click', function() {
  entidad.setAttribute('clipping-plane', 'enabled', 'false');
	alert("click");
});

document.getElementById('boton2').addEventListener('click', function() {
  entidad.setAttribute('clipping-plane', 'enabled', 'true');
});

document.getElementById('boton3').addEventListener('click', function() {
 entidad.setAttribute('clipping-plane', {dir: {x: 0, y: -0.22, z: 0},enabled:'true'});
});

document.getElementById('boton4').addEventListener('click', function() {
 entidad.setAttribute('clipping-plane', {dir: {x: -1, y: 0, z: 0},enabled:'true'});
});

document.getElementById('boton5').addEventListener('click', function() {
 entidad.setAttribute('clipping-plane', {dir: {x: 0, y: 0, z: -1},enabled:'true'});
});

myCheckbox.addEventListener('change', function() {
  const ldir= entidad.components['clipping-plane'].data.dir;//solo lectura
  const plane1 = document.querySelector('#plano1');
  const plane2 = document.querySelector('#plano2');
  const plane3 = document.querySelector('#plano3');
          plane1.setAttribute('visible', 'false');
          plane2.setAttribute('visible', 'false');
          plane3.setAttribute('visible', 'false'); 
       if (this.checked) {
         if(ldir.z==-1){
              plane1.setAttribute('visible','true');
			 alert("click");
           }else if(ldir.x==-1)
             {
              plane2.setAttribute('visible','true');
             }else if(ldir.y==-0.22){
              plane3.setAttribute('visible','true');
				 alert("click");
        }}});
	</script>
</html>

